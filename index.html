<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAG - MTs Al Amanah</title>
    <!-- Import Font dari Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Script untuk membaca file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        /* --- CSS DARI APLIKASI UTAMA (SIMAG) --- */
        :root {
            --primary-color: #00796b; /* Teal */
            --primary-hover: #00695c;
            --secondary-color: #5a6acf; /* Indigo-like */
            --secondary-hover: #4e5bb5;
            --danger-color: #dc3545; /* Red */
            --danger-hover: #c82333;

            --bg-light: #f8f9fa;
            --bg-body: #f4f7f9;
            --border-color: #dee2e6;
            --text-dark: #343a40;
            --text-muted: #6c757d;
            --text-light: #ffffff;
            --font-family-sans-serif: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

            --box-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --border-radius-sm: 5px;
            --transition-speed: 0.2s ease-in-out;
        }

        /* --- GLOBAL & BODY --- */
        body {
            font-family: var(--font-family-sans-serif);
            background-color: var(--bg-body);
            background-image: linear-gradient(170deg, #f4f7f9 0%, #e9edf2 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: var(--text-light);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            box-sizing: border-box;
            margin: 20px 0;
            transition: all var(--transition-speed);
            position: relative; /* Diperlukan untuk tombol logout/kembali */
        }

        /* --- HEADER & PAGE NAVIGATION --- */
        .header {
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .header h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
        }
        .header p {
            margin: 5px 0 0;
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        .page {
            display: none;
            animation: fadeIn 0.4s var(--transition-speed);
        }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #495057;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-sizing: border-box;
            background-color: var(--bg-light);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-dark);
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.15);
        }

        /* --- BUTTONS --- */
        button, .btn {
            padding: 12px 24px;
            border: 1px solid transparent;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            transition: all var(--transition-speed);
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        button:hover, .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-sm);
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }

        .btn-logout, .btn-back {
            position: absolute;
            top: 25px;
            right: 25px;
            padding: 8px 16px;
            font-size: 14px;
        }
        .btn-back {
            left: 25px;
            right: auto;
        }

        /* --- CARD MENU STYLES --- */
        .card-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .menu-card {
            background-color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            transition: all var(--transition-speed);
            box-shadow: var(--box-shadow-sm);
            cursor: pointer;
        }
        .menu-card .card-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            line-height: 1;
        }
        .menu-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--text-dark);
        }
        .menu-card p {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin: 0;
            flex-grow: 1;
        }
        .menu-card.menu-disabled {
            cursor: not-allowed;
            background-color: var(--bg-light);
            opacity: 0.7;
        }
        .menu-card:not(.menu-disabled):hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: var(--box-shadow);
        }


        /* --- LOGIN PAGE --- */
        #loginPage {
            max-width: 550px;
            margin: 50px auto;
            padding: 40px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: #fff;
            box-shadow: var(--box-shadow);
        }
        #loginPage h2 {
            text-align: center;
            margin-top: 25px;
            margin-bottom: 30px;
            color: var(--text-dark);
        }
        #loginPage button {
            width: 100%;
            margin-top: 10px;
        }
        #loginPage .header h1 { font-size: 1.8rem; }
        #loginPage .header p { font-size: 1rem; }

        .password-wrapper { position: relative; }
        .password-wrapper input { padding-right: 45px; }
        .toggle-password-icon {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-muted);
            user-select: none;
            display: flex;
            align-items: center;
        }

        /* --- CSS DARI APLIKASI ABSENSI (KEDUA) --- */
        #absensiPage {
            --primary-color: #4A5568; /* Slate Blue/Gray */
            --primary-color-dark: #2D3748;
            --secondary-color: #718096;
            --accent-color: #38B2AC; /* Teal */
            --accent-color-dark: #319795;
            --success-color: #48BB78;
            --danger-color: #F56565;
            --info-color: #4299E1;
            --bg-color: #F7FAFC;
            --surface-color: #FFFFFF;
            --text-color: #2D3748;
            --text-color-light: #718096;
            --border-color: #E2E8F0;
            --font-family: 'Poppins', sans-serif;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 8px;
        }

        #absensiPage h1, #absensiPage h2, #absensiPage h3 {
            color: var(--primary-color-dark);
            margin-top: 0;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        #absensiPage h1 { font-size: 2.25rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.75rem; }
        #absensiPage h2 { font-size: 1.75rem; margin-top: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        #absensiPage h3 { font-size: 1.25rem; border-bottom: none; color: var(--primary-color); }
        #absensiPage label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        #absensiPage .grid-2-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        #absensiPage .nav-menu { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; }
        #absensiPage .nav-button { padding: 1rem 1.5rem; cursor: pointer; border: none; background-color: transparent; font-size: 1rem; font-weight: 600; color: var(--secondary-color); border-bottom: 3px solid transparent; transform: translateY(1px); transition: all 0.3s ease; }
        #absensiPage .nav-button:hover { color: var(--primary-color); border-bottom-color: var(--accent-color); }
        #absensiPage .nav-button.active { color: var(--primary-color-dark); border-bottom-color: var(--primary-color-dark); }
        #absensiPage .page-content { display: none; animation: fadeIn 0.5s ease-in-out; }
        #absensiPage .page-content.active { display: block; }
        #absensiPage .form-group { background: #fdfdfd; padding: 1.5rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        #absensiPage input[type="text"], #absensiPage input[type="date"], #absensiPage select { width: 100%; padding: 0.75rem 1rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--surface-color); font-family: var(--font-family); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        #absensiPage input[type="text"]:focus, #absensiPage input[type="date"]:focus, #absensiPage select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(56, 178, 172, 0.2); }
        #absensiPage .btn, #absensiPage button { display: inline-flex; align-items: center; gap: 0.5rem; background-color: var(--primary-color); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: 600; font-family: var(--font-family); text-decoration: none; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; box-shadow: var(--shadow); margin: 5px 5px 5px 0; }
        #absensiPage .btn:hover, #absensiPage button:hover { background-color: var(--primary-color-dark); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        #absensiPage .btn-secondary { background-color: var(--secondary-color); } #absensiPage .btn-secondary:hover { background-color: #5a6268; }
        #absensiPage .btn-success { background-color: var(--success-color); } #absensiPage .btn-success:hover { background-color: #38A169; }
        #absensiPage .btn-info { background-color: var(--info-color); } #absensiPage .btn-info:hover { background-color: #2B6CB0; }
        #absensiPage .btn-danger { background-color: var(--danger-color); } #absensiPage .btn-danger:hover { background-color: #E53E3E; }
        #absensiPage .btn svg { width: 20px; height: 20px; }
        #absensiPage table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; box-shadow: var(--shadow); border-radius: var(--border-radius); overflow: hidden; }
        #absensiPage th, #absensiPage td { border-bottom: 1px solid var(--border-color); padding: 1rem; text-align: left; }
        #absensiPage thead { background-color: var(--primary-color); color: white; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.05em; }
        #absensiPage tbody tr:nth-child(even) { background-color: var(--bg-color); }
        #absensiPage tbody tr:hover { background-color: #EDF2F7; }
        #absensiPage .recap-edit-cell { cursor: pointer; text-align: center; font-weight: bold; transition: background-color 0.2s, color 0.2s; }
        #absensiPage .recap-edit-cell:hover { background-color: var(--accent-color); color: white; }
        #absensiPage .nonaktif-text { color: var(--danger-color); font-style: italic; font-size: 0.9em; }
        #absensiPage #recap-controls { display: flex; align-items: flex-end; gap: 1.5rem; flex-wrap: wrap; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { display: flex; align-items: center; padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); color: white; font-weight: 500; opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--info-color); }

        /* --- CSS DARI APLIKASI PROTA/PROSEM (KETIGA) --- */
        #protaProsemPage {
            --primary-color: #4A90E2; 
            --primary-darker: #357ABD;
            --secondary-color: #50E3C2;
            --header-bg: #2C3E50;
            --text-color: #34495E; 
            --text-muted: #7F8C8D;
            --bg-color: #F4F7F9;
            --card-bg: #FFFFFF;
            --border-color: #EAEFEC;
            --success-color: #27AE60;
            --danger-color: #E74C3C;
            --warning-color: #F39C12;
            --info-color: #3498DB;
            --font-family: 'Poppins', sans-serif;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 15px rgba(44, 62, 80, 0.08);
            --border-radius: 12px;
            --transition-speed: 0.3s ease;
        }
        #protaProsemPage * { box-sizing: border-box; }
        
        #protaProsemPage {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); 
            line-height: 1.6; padding: 0;
        }

        #protaProsemPage .main-container { max-width: 1200px; margin: 0 auto; padding: 0; }
        
        #protaProsemPage .app-header {
            text-align: center;
            margin-bottom: 40px;
        }
        #protaProsemPage .app-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--header-bg);
            margin: 0;
        }
        #protaProsemPage .app-header p {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        #protaProsemPage .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        #protaProsemPage .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            position: relative;
            z-index: 2;
        }
        #protaProsemPage .step-icon {
            width: 40px; height: 40px; border-radius: 50%; background-color: var(--card-bg);
            border: 2px solid var(--border-color); color: var(--text-muted);
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; transition: var(--transition-speed);
        }
        #protaProsemPage .step-label {
            margin-top: 10px; font-size: 13px; font-weight: 500;
            color: var(--text-muted); transition: var(--transition-speed);
        }
        #protaProsemPage .step.active .step-icon {
            background-color: var(--primary-color); border-color: var(--primary-color);
            color: white; transform: scale(1.1);
        }
        #protaProsemPage .step.active .step-label { color: var(--primary-color); font-weight: 600; }
        #protaProsemPage .step.completed .step-icon {
             background-color: var(--success-color); border-color: var(--success-color); color: white;
        }
        #protaProsemPage .stepper::before { /* Progress line */
            content: ''; position: absolute; top: 20px; left: 0; right: 0;
            height: 2px; background-color: var(--border-color); z-index: 1;
            transform: translateY(-50%);
        }
        #protaProsemPage #progress-line {
            position: absolute; top: 20px; left: 0;
            height: 2px; background-color: var(--success-color); z-index: 1;
            width: 0%; transform: translateY(-50%); transition: width 0.5s ease-in-out;
        }
        #protaProsemPage .card {
            background-color: var(--card-bg); border-radius: var(--border-radius);
            box-shadow: var(--shadow-md); padding: 30px; margin-bottom: 25px;
        }
        #protaProsemPage .card-header {
            margin: -30px -30px 25px -30px; padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
        }
        #protaProsemPage .card-header h3 {
            margin: 0; font-size: 1.25rem; color: var(--header-bg); display: flex; align-items: center; gap: 10px;
        }
        #protaProsemPage .step-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        #protaProsemPage .step-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #protaProsemPage .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        #protaProsemPage .info-item { display: flex; flex-direction: column; }
        #protaProsemPage .info-item label { font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 5px; }

        #protaProsemPage input, #protaProsemPage select { 
            width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); 
            border-radius: 8px; font-family: var(--font-family); font-size: 14px;
            transition: var(--transition-speed); background-color: #fcfdff;
        }
        #protaProsemPage input:focus, #protaProsemPage select:focus { 
            outline: none; border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); 
        }
        #protaProsemPage .table-grid-wrapper { display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; align-items: start; }
        #protaProsemPage .custom-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        #protaProsemPage .custom-table th, #protaProsemPage .custom-table td { padding: 14px 12px; text-align: center; vertical-align: middle; border-bottom: 1px solid var(--border-color); }
        #protaProsemPage .custom-table tbody tr:last-child td { border-bottom: none; }
        #protaProsemPage .custom-table thead th { 
            font-weight: 600; background-color: #F9FAFB; color: var(--header-bg); 
            text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; 
        }
        #protaProsemPage .custom-table tbody tr:hover { background-color: #fcfdff; }
        #protaProsemPage .custom-table tfoot td { background-color: #F9FAFB; font-weight: 700; }
        #protaProsemPage .custom-table td.align-left { text-align: left; }
        
        #protaProsemPage .button-group { display: flex; justify-content: center; gap: 15px; margin-top: 40px; flex-wrap: wrap; }
        #protaProsemPage .action-button {
            padding: 12px 28px; border: none; border-radius: var(--border-radius);
            font-size: 14px; font-weight: 600; cursor: pointer; color: white;
            transition: var(--transition-speed); text-transform: uppercase; letter-spacing: 0.8px;
            display: inline-flex; align-items: center; gap: 8px;
            box-shadow: var(--shadow-sm);
        }
        #protaProsemPage .action-button:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        #protaProsemPage .action-button:disabled { background-color: #bdc3c7 !important; cursor: not-allowed; transform: none; box-shadow: none; }
        #protaProsemPage .btn-primary { background-image: linear-gradient(45deg, var(--primary-darker) 0%, var(--primary-color) 100%); }
        #protaProsemPage .btn-secondary { background-color: #95A5A6; color: white; }
        #protaProsemPage .btn-success { background-image: linear-gradient(45deg, #27AE60 0%, #2ECC71 100%); }
        #protaProsemPage .btn-danger { background-color: var(--danger-color); padding: 8px 16px; font-size: 13px; }

        #protaProsemPage .calculation-summary { background-color: #F4F7F9; padding: 20px; border-radius: var(--border-radius); }
        #protaProsemPage .calculation-summary h4 { margin: 0 0 10px 0; color: var(--text-color); font-size: 1rem; }
        #protaProsemPage .calculation-summary b { color: var(--primary-color); font-size: 1.2rem; }
        #protaProsemPage .validation-message { 
            font-weight: 500; padding: 10px 15px; border-radius: 8px; display: inline-flex;
            align-items: center; gap: 8px; margin-top: 15px;
        }
        #protaProsemPage .validation-ok { background-color: #EAF7EC; color: var(--success-color); }
        #protaProsemPage .validation-error { background-color: #FADBD8; color: var(--danger-color); }
        
        #protaProsemPage .signature-container { display: flex; justify-content: space-around; gap: 20px; padding-top: 20px;}
        #protaProsemPage .signature-block { flex: 1; min-width: 200px; text-align: center; font-size: 14px; }
        #protaProsemPage .signature-space { height: 70px; }
        #protaProsemPage .signature-name { font-weight:bold; text-decoration:underline; }

        #protaProsemPage .konfirmasi-table .checkbox-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        #protaProsemPage .konfirmasi-table .custom-checkbox { position: relative; }
        #protaProsemPage .konfirmasi-table .custom-checkbox input { opacity: 0; width: 0; height: 0; }
        #protaProsemPage .konfirmasi-table .custom-checkbox label {
            cursor: pointer; padding: 8px 15px; border: 1px solid var(--border-color);
            border-radius: 20px; transition: var(--transition-speed); user-select: none;
        }
        #protaProsemPage .konfirmasi-table .custom-checkbox input:checked + label {
            background-color: var(--danger-color); color: white; border-color: var(--danger-color);
        }
        #protaProsemPage .konfirmasi-table .custom-checkbox label:hover {
            border-color: var(--primary-color);
        }
        
        #protaProsemPage .prosem-table .filled-week {
            background-color: #EAF7EC !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;
            color: var(--success-color) !important; font-weight: 700;
        }
        #protaProsemPage .output-document { display: none; }
        #protaProsemPage .output-header { text-align: center; margin-bottom: 25px; }
        #protaProsemPage .output-header h1 { font-size: 1.5rem; margin: 0; }
        #protaProsemPage .output-header h2 { font-size: 1.1rem; margin: 5px 0 20px; font-weight: 500; color: var(--text-muted); }
        #protaProsemPage .output-info-table { width: 100%; border: none; margin-bottom: 25px; font-size: 14px; }
        #protaProsemPage .output-info-table td { border: none; padding: 4px 0; }
        #protaProsemPage .output-info-table td:first-child { font-weight: 600; width: 180px; }
        
        /* Final Prosem/Prota tables */
        #protaProsemPage .prosem-table-wrapper { overflow-x: auto; }
        #protaProsemPage .prota-table th:nth-child(2), #protaProsemPage .prota-table td:nth-child(2) { width: 45%; }
        
        /* --- Print Styles --- */
        @media print {
            body { background-color: white !important; }
            .non-printable { display: none !important; }
            .container { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; }
            .page:not(#protaProsemPage) { display: none !important; }

            #protaProsemPage { padding-top: 0 !important; }
            #protaProsemPage .step-content { display: none !important; }
            #protaProsemPage .output-document.active { display: block !important; }
            #protaProsemPage .card-header { margin: 0 0 20px 0; padding: 0; border: none; }
            #protaProsemPage .output-header { margin-bottom: 20px; }
            #protaProsemPage .output-header h1 { font-size: 14pt; }
            #protaProsemPage .output-header h2 { font-size: 11pt; }
            #protaProsemPage .custom-table { box-shadow: none; font-size: 9pt; }
            #protaProsemPage .custom-table th, #protaProsemPage .custom-table td { padding: 5px 6px; }
            #protaProsemPage .prosem-table-wrapper { overflow-x: visible !important; }
            #protaProsemPage #prosem-content .prosem-table { font-size: 8pt; }
            #protaProsemPage #prosem-content .prosem-table th, #protaProsemPage #prosem-content .prosem-table td { padding: 4px; }
            #protaProsemPage .signature-container { page-break-inside: avoid; margin-top: 40px; }
            #protaProsemPage input, #protaProsemPage select { border: none !important; background: transparent !important; padding: 0 !important; font-size: inherit !important; color: inherit !important; }
            #protaProsemPage input[value=""] { border-bottom: 1px dotted #999 !important; }
            #protaProsemPage .table-grid-wrapper { grid-template-columns: 1fr 1fr; gap: 20px; }
        }
        #protaProsemPage.page { padding: 0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Konten akan di-inject oleh JavaScript -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const appContainer = document.querySelector('.container');

            // --- HTML TEMPLATES FOR EACH PAGE ---

            const loginPageHTML = `
                <div id="loginPage" class="page">
                    <div class="header" style="border-bottom: none;">
                        <img src="https://i.imgur.com/MQBHM5m.png" alt="Logo MTs Al Amanah" style="width: 70px; margin-bottom: 15px;">
                        <h1>Sistem Informasi Manajemen Administrasi Guru v2.0</h1>
                        <p>MTs Al Amanah<br><small style="font-weight: 400; font-size: 0.85em; color: var(--text-muted);">Jl. Rulita Km 08, RT 002 RW 007, Kel. Harjasari, Kec. Bogor Selatan, Kota Bogor 16138</small></p>
                    </div>
                    <h2>Login Guru</h2>
                    <form id="loginForm">
                        <div class="form-group"><label for="email">Email</label><input type="email" id="email" placeholder="Ketik email Anda" required></div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <div class="password-wrapper">
                                <input type="password" id="password" placeholder="Ketik password Anda" required>
                                <span id="togglePassword" class="toggle-password-icon"></span>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Login</button>
                    </form>
                </div>`;

            const portalPageHTML = `
                <div id="portalPage" class="page">
                    <button id="portalLogoutBtn" class="btn-danger btn-logout">Logout</button>
                    <div class="header">
                        <h1>Menu Utama</h1>
                        <p>Selamat datang! Silakan pilih menu yang ingin Anda gunakan.</p>
                    </div>
                    <div class="card-menu">
                        <div class="menu-card" data-page="absensiPage">
                            <div class="card-icon">üóìÔ∏è</div>
                            <h3>Absensi Guru Mapel</h3>
                            <p>Klik untuk membuka aplikasi absensi, rekapitulasi, dan manajemen data siswa.</p>
                        </div>
                         <div class="menu-card" data-page="protaProsemPage">
                            <div class="card-icon">‚è≥</div>
                            <h3>Alokasi Waktu, Prosem dan Prota</h3>
                            <p>Fitur untuk manajemen alokasi waktu, program semester, dan program tahunan.</p>
                        </div>
                        <div class="menu-card menu-disabled">
                            <div class="card-icon">üî¨</div>
                            <h3>Analisis Soal dan Tindak Lanjut</h3>
                            <p>Fitur analisis butir soal, daya pembeda, tingkat kesukaran, dan rencana tindak lanjut. (Sedang dalam pengembangan)</p>
                        </div>
                    </div>
                </div>`;

            const absensiPageHTML = `
                <div id="absensiPage" class="page">
                    <button id="backToPortalBtn" class="btn-secondary btn-back">Kembali ke Menu</button>
                    <div id="toast-container"></div>
                    <div id="setup-container" style="display: none;">
                        <h2>Setup Awal Aplikasi</h2>
                        <p>Selamat datang! Aplikasi ini memerlukan data siswa untuk dapat beroperasi. Silakan unduh template Excel di bawah, isi sesuai data siswa, lalu unggah kembali.</p>
                        <button id="download-template-btn" class="btn btn-info"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Unduh Template</button>
                        <div style="margin-top: 2rem;">
                            <label for="student-upload-input" class="btn btn-success"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l4 4m0 0l-4 4m4-4H4"/></svg>Unggah File Data Siswa</label>
                            <input type="file" id="student-upload-input" accept=".xlsx, .xls" style="display: none;">
                        </div>
                        <div id="upload-summary" style="margin-top: 1rem;"></div>
                        <button id="start-app-btn" style="display:none; margin-top: 1rem;" class="btn btn-success">Lanjutkan ke Aplikasi</button>
                    </div>
                    <div id="main-app-container" style="display: none;">
                        <h1>Aplikasi Absensi</h1>
                        <div class="nav-menu">
                            <button class="nav-button active" data-page="isi-absensi-page">Isi Absensi</button>
                            <button class="nav-button" data-page="riwayat-page">Riwayat & Rekap</button>
                            <button class="nav-button" data-page="manajemen-page">Manajemen Data</button>
                        </div>
                        <div id="isi-absensi-page" class="page-content active">
                            <h2>Form Absensi Harian</h2>
                            <div class="form-group">
                                <form id="attendance-form" class="grid-2-col">
                                    <div><label for="teacher-name">Nama Guru</label><input type="text" id="teacher-name" required></div>
                                    <div><label for="subject">Mata Pelajaran</label><select id="subject" required><option value="">-- Pilih Mapel --</option><option value="IPS">IPS</option><option value="Bahasa Inggris">Bahasa Inggris</option></select></div>
                                    <div><label for="class-select">Kelas</label><select id="class-select" required></select></div>
                                    <div><label for="attendance-date">Tanggal</label><input type="date" id="attendance-date" required></div>
                                </form>
                                <button type="button" id="show-attendance-btn" class="btn btn-success" style="margin-top: 1rem;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>Tampilkan Daftar Siswa</button>
                            </div>
                            <div id="attendance-taking-section" style="display: none;">
                                <h2 id="attendance-header"></h2><div style="overflow-x:auto;"><table><thead><tr><th>No</th><th>NISN</th><th>Nama Siswa</th><th>Hadir</th><th>Keterangan</th></tr></thead><tbody id="attendance-table-body"></tbody></table></div>
                                <button id="save-attendance-btn" class="btn btn-success" style="margin-top: 1.5rem;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>Simpan Absensi</button>
                            </div>
                        </div>
                        <div id="riwayat-page" class="page-content">
                             <h2>Rekapitulasi Absensi</h2>
                            <div class="form-group">
                                <div id="recap-controls"><label for="recap-class-filter">Tampilkan Riwayat untuk Kelas:</label><select id="recap-class-filter"></select><button id="download-recap-btn" class="btn btn-success"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Unduh Rekap Kelas Ini</button></div>
                                <p style="font-size: 0.9em; margin-top: 1rem; color: var(--text-color-light);"><b>Tips:</b> Klik pada status (H/S/I/A) di tabel untuk mengedit absensi hari tersebut.</p>
                            </div>
                            <div style="overflow-x:auto;"><table id="recap-table"><thead></thead><tbody></tbody></table></div>
                        </div>
                        <div id="manajemen-page" class="page-content">
                            <h2>Manajemen Data</h2>
                            <div class="form-group">
                                <h3>Manajemen Data Siswa</h3><p>Gunakan menu ini untuk menambah atau memperbarui daftar siswa secara massal.</p><button id="manajemen-download-template-btn" class="btn btn-info"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Unduh Template</button>
                                <label for="manajemen-student-upload-input" class="btn btn-success" style="cursor:pointer;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l4 4m0 0l-4 4m4-4H4"/></svg>Unggah Ulang (Ganti Semua)</label>
                                <input type="file" id="manajemen-student-upload-input" accept=".xlsx, .xls" style="display: none;"><div id="manajemen-upload-summary" style="margin-top: 1rem;"></div>
                            </div>
                            <div class="form-group">
                                <h3>Tambah Siswa Baru (Per Orang)</h3>
                                <form id="add-student-form" class="grid-2-col">
                                    <div><label>NISN</label><input type="text" id="add-nisn" required></div><div><label>Nama Lengkap</label><input type="text" id="add-nama" required></div>
                                    <div><label>Jenis Kelamin</label><select id="add-gender" required><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div>
                                    <div><label>Kelas</label><select id="add-class" required></select></div>
                                </form>
                                <button type="button" id="add-student-btn" class="btn btn-success" style="margin-top:1rem;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>Tambah Siswa</button>
                            </div>
                            <div class="form-group">
                                <h3>Kelola Status Siswa</h3>
                                <div class="grid-2-col"><div><label>Pilih Kelas</label><select id="manage-class-select"></select></div><div><label>Pilih Siswa</label><select id="manage-student-select"></select></div></div>
                                <button id="deactivate-student-btn" class="btn btn-danger" style="margin-top:1rem;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zm12-2h-6"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364L15 15m3.364 0l-3.364 3.364"/></svg>Nonaktifkan Siswa</button>
                                <button id="activate-student-btn" class="btn btn-success" style="margin-top:1rem;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zm12-2h-6"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Aktifkan Kembali</button>
                            </div>
                            <div class="form-group">
                                <h3>Pengaturan & Cadangan Data</h3>
                                <button id="download-attendance-btn" class="btn btn-info"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Unduh Semua Riwayat Absensi</button>
                                <button id="backup-btn" class="btn btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>Backup Seluruh Data</button>
                                <button id="restore-btn" class="btn btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 9a9 9 0 0114.65-4.65l-2.12 2.12A5.001 5.001 0 009 14.12V16h1.88a5.001 5.001 0 007.24-8.24l2.12-2.12A9 9 0 0120 15"/></svg>Restore dari Backup</button>
                                <input type="file" id="restore-input" accept=".json" style="display:none;">
                                <button id="reset-app-btn" class="btn btn-danger"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>Reset Aplikasi</button>
                            </div>
                        </div>
                    </div>
                </div>`;

            const protaProsemPageHTML = `
                <div id="protaProsemPage" class="page">
                    <button id="backToPortalBtnProta" class="btn-secondary btn-back">Kembali ke Menu</button>
                    <div class="main-container">
                        <header class="app-header">
                            <h1>Alokasi Waktu, Prosem dan Prota</h1>
                            <p>MTs Al Amanah</p>
                        </header>

                        <div class="stepper non-printable">
                            <div id="progress-line"></div>
                            <div class="step active" data-step="1"> <div class="step-icon">1</div><div class="step-label">Alokasi Waktu</div></div>
                            <div class="step" data-step="2"><div class="step-icon">2</div><div class="step-label">Konfirmasi Jadwal</div></div>
                            <div class="step" data-step="3"><div class="step-icon">3</div><div class="step-label">Penyusunan Materi</div></div>
                            <div class="step" data-step="4"><div class="step-icon"><i class="fa-solid fa-check"></i></div><div class="step-label">Hasil Akhir</div></div>
                        </div>

                        <!-- Step 1: Alokasi Waktu -->
                        <div id="alokasi-waktu-section" class="step-content active">
                            <div class="card">
                                <div class="card-header"><h3><i class="fa-solid fa-sitemap"></i> Informasi Umum & Identitas</h3></div>
                                <div class="info-grid">
                                    <div class="info-item"><label for="info-sekolah">Nama Madrasah</label><input type="text" id="info-sekolah" value="MTs Al Amanah" readonly></div>
                                    <div class="info-item"><label for="info-mapel">Mata Pelajaran</label><input type="text" id="info-mapel" placeholder="Contoh: Ilmu Pengetahuan Sosial (IPS)"></div>
                                    <div class="info-item"><label for="info-kelas">Kelas / Semester</label><div style="display:flex; gap:10px;"><input type="text" id="info-kelas" placeholder="VII" style="flex-basis: 100px; flex-grow: 0;"><select id="semester-selector" style="flex-grow: 1;"><option value="ganjil" selected>Semester I (Ganjil)</option><option value="genap">Semester II (Genap)</option></select></div></div>
                                    <div class="info-item"><label for="info-tapel">Tahun Pelajaran</label><input type="text" id="info-tapel" placeholder="2024/2025"></div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3><i class="fa-solid fa-calendar-days"></i> A. Perhitungan Alokasi Waktu</h3></div>
                                <div class="table-grid-wrapper">
                                     <div>
                                        <h4>1. Jumlah Minggu per Bulan</h4>
                                        <table class="custom-table main-table">
                                            <thead><tr><th>No</th><th class="align-left">Bulan</th><th>Jml.</th><th>T.E.</th><th>Efektif</th></tr></thead>
                                            <tbody id="week-table-body"></tbody>
                                            <tfoot><tr><td colspan="2" class="align-left">JUMLAH</td><td id="total-minggu">0</td><td id="total-tidak-efektif">0</td><td id="total-efektif">0</td></tr></tfoot>
                                        </table>
                                    </div>
                                     <div>
                                        <h4>2. Rincian Minggu Tidak Efektif (T.E.)</h4>
                                        <table class="custom-table uraian-table">
                                            <thead><tr><th>No</th><th class="align-left">Uraian Kegiatan</th><th>Jumlah</th></tr></thead>
                                            <tbody id="uraian-table-body"></tbody>
                                            <tfoot><tr><td colspan="2" class="align-left">JUMLAH</td><td id="total-uraian-minggu">0</td></tr></tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3><i class="fa-solid fa-calculator"></i> B. Rangkuman & Validasi</h3></div>
                                <div class="calculation-summary">
                                    <div style="display: flex; justify-content: space-around; text-align: center;">
                                        <div><h4>Total Minggu Efektif</h4><p><span id="summary-total-minggu">0</span> - <span id="summary-tidak-efektif">0</span> = <b><span id="summary-efektif">0</span> Minggu</b></p></div>
                                        <div><h4>Total Jam Pelajaran (JP)</h4><p style="display: flex; align-items: center; gap: 10px;"><span id="summary-efektif-2">0</span> Minggu √ó <input type="number" id="jpPerMinggu" value="2" min="1" style="width: 80px;"> JP = <b><span id="summary-total-jp">0</span> JP</b></p></div>
                                    </div>
                                </div>
                                <p style="margin-top:20px; text-align: center;"><b>Status Validasi:</b> <span id="validation-message"></span></p>
                            </div>
                            <div class="button-group non-printable"><button class="action-button btn-success" id="lanjut-ke-konfirmasi"><i class="fa-solid fa-arrow-right"></i> Lanjutkan</button></div>
                        </div>
                        
                        <!-- Step 2: Konfirmasi Minggu -->
                        <div id="prosem-konfirmasi-section" class="step-content">
                            <div class="card">
                                 <div class="card-header"><h3><i class="fa-solid fa-calendar-xmark"></i> Konfirmasi Minggu Tidak Efektif</h3></div>
                                 <p style="text-align:center; color: var(--text-muted); margin-top:-10px; margin-bottom:30px;">Berdasarkan data sebelumnya, sistem telah menandai jumlah minggu tidak efektif per bulan.<br>Silakan konfirmasi atau ubah minggu spesifik mana saja yang tidak digunakan untuk KBM.</p>
                                 <table class="custom-table konfirmasi-table">
                                    <thead><tr><th style="width:200px;">Bulan</th><th>Pilih Minggu yang Tidak Aktif</th></tr></thead>
                                    <tbody id="konfirmasi-tbody"></tbody>
                                 </table>
                            </div>
                            <div class="button-group non-printable">
                                <button class="action-button btn-secondary" id="kembali-ke-langkah-1"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
                                <button class="action-button btn-success" id="lanjut-ke-langkah-3"><i class="fa-solid fa-arrow-right"></i> Lanjutkan ke Penyusunan</button>
                            </div>
                        </div>

                        <!-- Step 3: Penyusunan Materi -->
                        <div id="prosem-final-section" class="step-content">
                            <div class="card">
                                 <div class="card-header"><h3><i class="fa-solid fa-book-open-reader"></i> Alokasi Materi Pembelajaran</h3></div>
                                 <div style="text-align:center; margin-bottom: 30px;">
                                    <p style="color: var(--text-muted); margin-top:-10px;">Alokasikan Jam Pelajaran (JP) ke setiap Materi / Tujuan Pembelajaran (TP).</p>
                                    <div id="jp-tersedia-container" style="background: #F4F7F9; padding: 15px; border-radius: 10px; display:inline-block;">
                                        Total JP Efektif Tersedia: <b style="font-size: 1.2rem; color: var(--primary-color);">0 JP</b>
                                    </div>
                                 </div>
                                 <table class="custom-table penyusunan-table">
                                    <thead><tr><th style="width:5%;">No.</th><th class="align-left" style="width:50%;">Materi Pokok / TP</th><th class="align-left" style="width:25%;">Lingkup Materi</th><th style="width:10%;">Alokasi (JP)</th><th style="width:10%;">Aksi</th></tr></thead>
                                    <tbody id="penyusunan-tbody"></tbody>
                                    <tfoot>
                                        <tr><td colspan="3" class="align-left" style="text-align: right; font-weight: bold;">TOTAL JP DIALOKASIKAN</td><td id="total-jp-dialokasikan" style="font-weight: bold;">0</td><td></td></tr>
                                    </tfoot>
                                 </table>
                                 <div id="validation-status-container" style="text-align: center; margin-top:20px;"></div>
                            </div>
                            <div class="button-group non-printable" style="justify-content: space-between;">
                                <button class="action-button btn-primary" id="tambah-baris-penyusunan"><i class="fa-solid fa-plus"></i> Tambah Baris</button>
                                <div>
                                    <button class="action-button btn-secondary" id="kembali-ke-langkah-2"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
                                    <button class="action-button btn-success" id="generate-button" disabled><i class="fa-solid fa-cogs"></i> Generate Hasil</button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Hasil Akhir -->
                        <div id="hasil-section" class="step-content">
                            <div class="card">
                                 <div class="card-header"><h3><i class="fa-solid fa-file-signature"></i> Finalisasi & Tanda Tangan</h3></div>
                                 <p style="color: var(--text-muted); text-align:center; margin-top:-10px;">Lengkapi data penandatangan untuk dicantumkan pada semua dokumen.</p>
                                 <div class="info-grid" style="grid-template-columns: 1fr 1fr;">
                                     <div class="info-item"><label for="input-nama-kepsek">Nama Kepala Madrasah</label><input type="text" id="input-nama-kepsek" placeholder="Nama Lengkap dengan Gelar"></div>
                                     <div class="info-item"><label for="input-nip-kepsek">NIP Kepala</label><input type="text" id="input-nip-kepsek" placeholder="Isi NIP atau -"></div>
                                     <div class="info-item"><label for="input-nama-guru">Nama Guru Mata Pelajaran</label><input type="text" id="input-nama-guru" placeholder="Nama Lengkap dengan Gelar"></div>
                                     <div class="info-item"><label for="input-nip-guru">NIP Guru</label><input type="text" id="input-nip-guru" placeholder="Isi NIP atau -"></div>
                                     <div class="info-item"><label for="info-lokasi">Lokasi Pembuatan Dokumen</label><input type="text" id="info-lokasi" value="Kota Bogor" readonly></div>
                                     <div class="info-item"><label for="info-tanggal">Tanggal Pembuatan</label><input type="date" id="info-tanggal"></div>
                                 </div>
                            </div>
                            <div class="button-group non-printable">
                                <button class="action-button btn-secondary" id="kembali-ke-langkah-3-hasil"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
                                <button class="action-button btn-primary" id="cetakAlokasiWaktu"><i class="fa-solid fa-calendar-check"></i> Cetak Alokasi Waktu</button>
                                <button class="action-button btn-primary" id="cetakProsem"><i class="fa-solid fa-table-cells-large"></i> Cetak Program Semester</button>
                                <button class="action-button btn-primary" id="cetakProta"><i class="fa-solid fa-table-list"></i> Cetak Program Tahunan</button>
                            </div>
                        </div>
                    </div>
                    <!-- Placeholder for Printable Documents -->
                    <div id="print-area"></div>
                </div>`;


            // Inject all HTML templates into the container
            appContainer.innerHTML = loginPageHTML + portalPageHTML + absensiPageHTML + protaProsemPageHTML;

            // Start the main application logic
            startApp();
        });

        // =========================================================================
        // MAIN APP LOGIC (SIMAG)
        // =========================================================================
        let absensiAppInitialized = false;
        let protaProsemAppInitialized = false;

        function startApp() {
            // --- Helper functions ---
            const showPage = (pageId) => {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const pageToShow = document.getElementById(pageId);
                if (pageToShow) pageToShow.classList.add('active');

                // Initialize the attendance app only when its page is shown for the first time
                if (pageId === 'absensiPage' && !absensiAppInitialized) {
                    initializeAbsensiApp();
                    absensiAppInitialized = true;
                }
                
                // Initialize the prota/prosem app only when its page is shown for the first time
                if (pageId === 'protaProsemPage' && !protaProsemAppInitialized) {
                    initializeProtaProsemApp();
                    protaProsemAppInitialized = true;
                }
            };

            const setupPasswordToggle = () => {
                const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
                const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;
                const togglePassword = document.getElementById('togglePassword');
                const passwordInput = document.getElementById('password');
                if (togglePassword && passwordInput) {
                    togglePassword.innerHTML = eyeIcon;
                    togglePassword.addEventListener('click', function() {
                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);
                        this.innerHTML = type === 'password' ? eyeIcon : eyeSlashIcon;
                    });
                }
            };

            // --- Event Listeners ---
            document.getElementById('loginForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                if (email === 'admin@gmail.com' && pass === 'admin123') {
                    showPage('portalPage');
                } else {
                    alert('Email atau Password salah!');
                }
            });

            document.getElementById('portalLogoutBtn')?.addEventListener('click', () => showPage('loginPage'));
            document.getElementById('backToPortalBtn')?.addEventListener('click', () => showPage('portalPage'));
            document.getElementById('backToPortalBtnProta')?.addEventListener('click', () => showPage('portalPage'));

            document.querySelector('.card-menu')?.addEventListener('click', (e) => {
                const card = e.target.closest('.menu-card[data-page]');
                if (card && !card.classList.contains('menu-disabled')) {
                    showPage(card.dataset.page);
                }
            });

            // --- Initial Setup ---
            setupPasswordToggle();
            showPage('loginPage'); // Initial page
        }


        // =========================================================================
        // ATTENDANCE APP LOGIC (FROM SECOND FILE)
        // =========================================================================
        function initializeAbsensiApp() {
            // --- TOAST NOTIFICATION FUNCTION ---
            const showToast = (message, type = 'info') => {
                const toastContainer = document.getElementById('absensiPage').querySelector('#toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.classList.add('show'); }, 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            };

            const DB = {
                getStudentData: () => JSON.parse(localStorage.getItem('studentData')) || null,
                setStudentData: (data) => localStorage.setItem('studentData', JSON.stringify(data)),
                getAttendanceData: () => JSON.parse(localStorage.getItem('attendanceData')) || {},
                setAttendanceData: (data) => localStorage.setItem('attendanceData', JSON.stringify(data)),
                clearAll: () => localStorage.clear()
            };

            const setupContainer = document.getElementById('setup-container');
            const mainAppContainer = document.getElementById('main-app-container');

            const startOrSetup = () => {
                 if (!DB.getStudentData()) {
                    setupContainer.style.display = 'block';
                    mainAppContainer.style.display = 'none';
                } else {
                    mainAppContainer.style.display = 'block';
                    setupContainer.style.display = 'none';
                    populateAllClassDropdowns();
                    setupNavigation();
                    renderRecapTable();
                }
            }

            function setupAppCore() {
                setupAllEventListeners();
                document.getElementById('attendance-date').valueAsDate = new Date();
                startOrSetup();
            }

            function setupAllEventListeners() {
                 document.getElementById('download-template-btn').addEventListener('click', downloadStudentTemplate);
                document.getElementById('student-upload-input').addEventListener('change', (e) => processStudentFile(e, false));
                document.getElementById('start-app-btn')?.addEventListener('click', () => location.reload());
                document.getElementById('show-attendance-btn').addEventListener('click', showAttendanceList);
                document.getElementById('attendance-taking-section').addEventListener('change', (e) => { if (e.target.classList.contains('status-checkbox')) { e.target.closest('tr').querySelector('.keterangan-select').style.display = e.target.checked ? 'none' : 'block'; } });
                document.getElementById('save-attendance-btn').addEventListener('click', handleSaveAttendance);
                document.getElementById('recap-class-filter').addEventListener('change', renderRecapTable);
                document.getElementById('recap-table').addEventListener('click', handleRecapEdit);
                document.getElementById('download-recap-btn').addEventListener('click', handleDownloadFilteredRecap);
                document.getElementById('manajemen-download-template-btn').addEventListener('click', downloadStudentTemplate);
                document.getElementById('manajemen-student-upload-input').addEventListener('change', (e) => processStudentFile(e, true));
                document.getElementById('add-student-btn').addEventListener('click', handleAddStudent);
                document.getElementById('manage-class-select').addEventListener('change', populateManageStudentDropdown);
                document.getElementById('deactivate-student-btn').addEventListener('click', () => toggleStudentStatus('Nonaktif'));
                document.getElementById('activate-student-btn').addEventListener('click', () => toggleStudentStatus('Aktif'));
                document.getElementById('download-attendance-btn').addEventListener('click', handleDownloadAllAttendance);
                document.getElementById('backup-btn').addEventListener('click', handleBackup);
                document.getElementById('restore-btn').addEventListener('click', () => document.getElementById('restore-input').click());
                document.getElementById('restore-input').addEventListener('change', handleRestore);
                document.getElementById('reset-app-btn').addEventListener('click', handleReset);
            }

            function handleSaveAttendance() { /* ... handlers ... */
                const teacher = document.getElementById('teacher-name').value, subject = document.getElementById('subject').value, selectedClass = document.getElementById('class-select').value, date = document.getElementById('attendance-date').value;
                const attendanceKey = `${date}_${selectedClass}_${subject}`;
                const attendanceData = DB.getAttendanceData();
                const newRecord = { teacher: teacher, records: {} };
                document.getElementById('attendance-table-body').querySelectorAll('tr').forEach(row => {
                    const checkbox = row.querySelector('.status-checkbox');
                    newRecord.records[checkbox.dataset.nisn] = checkbox.checked ? 'H' : row.querySelector('.keterangan-select').value;
                });
                attendanceData[attendanceKey] = newRecord;
                DB.setAttendanceData(attendanceData);
                showToast('Data absensi berhasil disimpan!', 'success');
                document.getElementById('attendance-taking-section').style.display = 'none';
            }
            function handleRecapEdit(e) { /* ... handlers ... */
                if (e.target.classList.contains('rekap-edit-cell')) {
                    const { date, subject, teacher } = e.target.dataset;
                    const selectedClass = document.getElementById('recap-class-filter').value;
                    document.querySelector('#absensiPage .nav-button[data-page="isi-absensi-page"]').click();
                    document.getElementById('teacher-name').value = teacher;
                    document.getElementById('subject').value = subject;
                    document.getElementById('class-select').value = selectedClass;
                    document.getElementById('attendance-date').value = date;
                    showAttendanceList();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
            function handleDownloadFilteredRecap() { /* ... handlers ... */
                const selectedClass = document.getElementById('recap-class-filter').value;
                if (!selectedClass) return showToast('Pilih kelas terlebih dahulu.', 'error');
                const table = document.getElementById('recap-table');
                if (table.rows.length <= 1 || (table.rows.length === 2 && table.rows[1].cells.length <= 3)) { return showToast('Tidak ada data rekap untuk diunduh.', 'info'); }
                const tableClone = table.cloneNode(true);
                tableClone.querySelectorAll('th small').forEach(el => el.parentNode.innerHTML = el.parentNode.textContent);
                tableClone.querySelectorAll('td span.nonaktif-text').forEach(el => el.remove());
                const wb = XLSX.utils.table_to_book(tableClone, { sheet: `Rekap Kelas ${selectedClass}` });
                XLSX.writeFile(wb, `rekap_kelas_${selectedClass}.xlsx`);
                showToast('File rekap berhasil diunduh.', 'success');
            }
            function handleDownloadAllAttendance() { /* ... handlers ... */
                const allStudentData = DB.getStudentData(), attendanceData = DB.getAttendanceData();
                if (Object.keys(attendanceData).length === 0) return showToast('Tidak ada data absensi untuk diunduh.', 'info');
                const flatData = [];
                for (const key in attendanceData) {
                    const [date, className, subject] = key.split('_');
                    for (const nisn in attendanceData[key].records) {
                        const student = allStudentData[className]?.find(s => s.NISN == nisn);
                        flatData.push({ 'Tanggal': date, 'Kelas': className, 'Mapel': subject, 'Guru': attendanceData[key].teacher, 'NISN': nisn, 'Nama Siswa': student ? student.Nama : 'N/A', 'Status': attendanceData[key].records[nisn] });
                    }
                }
                const worksheet = XLSX.utils.json_to_sheet(flatData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Rekap Absensi');
                XLSX.writeFile(workbook, 'rekap_absensi_lengkap.xlsx');
                showToast('Seluruh riwayat absensi berhasil diunduh.', 'success');
            }
            function handleBackup() { /* ... handlers ... */
                const dataToBackup = { studentData: DB.getStudentData(), attendanceData: DB.getAttendanceData() };
                const dataStr = JSON.stringify(dataToBackup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_absensi_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(a.href);
                showToast('Backup data berhasil dibuat.', 'success');
            }
            function handleRestore(event) { /* ... handlers ... */
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (restoredData.studentData && restoredData.attendanceData) {
                            if (confirm('Yakin ingin memulihkan data dari file ini? Data yang ada saat ini akan ditimpa.')) {
                                DB.setStudentData(restoredData.studentData); DB.setAttendanceData(restoredData.attendanceData);
                                showToast('Data berhasil dipulihkan! Aplikasi akan dimuat ulang.', 'success');
                                setTimeout(() => location.reload(), 2000);
                            }
                        } else { showToast('File backup tidak valid.', 'error'); }
                    } catch (error) { showToast('Gagal memproses file backup.', 'error'); }
                };
                reader.readAsText(file); event.target.value = '';
            }
            function handleReset() { /* ... handlers ... */
                if (confirm('APAKAH ANDA YAKIN? Semua data siswa dan data absensi akan dihapus secara permanen.')) {
                    DB.clearAll();
                    showToast('Aplikasi telah di-reset. Halaman akan dimuat ulang.', 'success');
                    setTimeout(() => location.reload(), 2000);
                }
            }
            function downloadStudentTemplate() { /* ... helpers ... */
                const sampleData = [{ 'NISN': '1234567890', 'Nama': 'Budi Santoso', 'Jenis Kelamin (L/P)': 'L', 'Kelas': '7A' }, { 'NISN': '0987654321', 'Nama': 'Citra Lestari', 'Jenis Kelamin (L/P)': 'P', 'Kelas': '7A' }];
                const worksheet = XLSX.utils.json_to_sheet(sampleData); const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'DataSiswa'); XLSX.writeFile(workbook, 'template_siswa.xlsx');
            }
            function processStudentFile(event, isUpdate) { /* ... helpers ... */
                const file = event.target.files[0]; if (!file) return;
                const summaryElement = isUpdate ? document.getElementById('manajemen-upload-summary') : document.getElementById('upload-summary');
                summaryElement.innerHTML = 'Memproses file...';
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        if (json.length > 0 && 'NISN' in json[0] && 'Nama' in json[0] && 'Jenis Kelamin (L/P)' in json[0] && 'Kelas' in json[0]) {
                            if (isUpdate && !confirm('Yakin ingin mengganti data siswa yang ada?')) { event.target.value = ''; summaryElement.innerHTML = ''; return; }
                            const studentData = {}, summary = {};
                            json.forEach(student => {
                                const kelas = student.Kelas.toString().trim();
                                if (!studentData[kelas]) { studentData[kelas] = []; summary[kelas] = { total: 0, L: 0, P: 0 }; }
                                studentData[kelas].push({ NISN: student.NISN, Nama: student.Nama, 'Jenis Kelamin (L/P)': student['Jenis Kelamin (L/P)'], Kelas: kelas, status: 'Aktif' });
                                summary[kelas].total++;
                                if (String(student['Jenis Kelamin (L/P)']).toUpperCase() === 'L') summary[kelas].L++; else if (String(student['Jenis Kelamin (L/P)']).toUpperCase() === 'P') summary[kelas].P++;
                            });
                            DB.setStudentData(studentData);
                            let summaryHTML = '<strong>Data berhasil diproses:</strong><ul>';
                            for (const kelas in summary) summaryHTML += `<li><b>Kelas ${kelas}:</b> ${summary[kelas].total} siswa (L: ${summary[kelas].L}, P: ${summary[kelas].P})</li>`;
                            summaryElement.innerHTML = summaryHTML + '</ul>';
                            if (isUpdate) { showToast('Data siswa berhasil diperbarui! Halaman akan dimuat ulang.', 'success'); setTimeout(() => location.reload(), 2000); }
                            else { document.getElementById('start-app-btn').style.display = 'inline-flex'; }
                            event.target.value = '';
                        } else { throw new Error('Format file tidak sesuai.'); }
                    } catch (err) { summaryElement.innerHTML = ''; showToast(err.message, 'error'); }
                };
                reader.readAsArrayBuffer(file);
            }
            function populateAllClassDropdowns() { /* ... helpers ... */
                const classes = []; for (let grade of [7, 8, 9]) for (let letter of ['A', 'B', 'C', 'D']) classes.push(`${grade}${letter}`);
                const selectors = ['#class-select', '#recap-class-filter', '#add-class', '#manage-class-select'];
                selectors.forEach(selector => {
                    const select = document.querySelector(selector);
                    if (!select) return;
                    select.innerHTML = (selector === '#class-select' || selector === '#manage-class-select' || selector === '#add-class') ? '<option value="">-- Pilih Kelas --</option>' : '';
                    classes.forEach(cls => { const option = document.createElement('option'); option.value = cls; option.textContent = cls; select.appendChild(option); });
                });
            }
            function setupNavigation() { /* ... helpers ... */
                const navButtons = document.querySelectorAll('#absensiPage .nav-button'), pages = document.querySelectorAll('#absensiPage .page-content');
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        navButtons.forEach(btn => btn.classList.remove('active'));
                        pages.forEach(page => page.classList.remove('active'));
                        button.classList.add('active');
                        document.getElementById(button.dataset.page).classList.add('active');
                        if (button.dataset.page === 'riwayat-page') renderRecapTable();
                        if (button.dataset.page === 'manajemen-page') populateManageStudentDropdown();
                    });
                });
            }
            function handleAddStudent() { /* ... helpers ... */
                const nisn = document.getElementById('add-nisn').value.trim(), nama = document.getElementById('add-nama').value.trim(), gender = document.getElementById('add-gender').value, kelas = document.getElementById('add-class').value;
                if (!nisn || !nama || !kelas) return showToast('Harap isi semua field.', 'error');
                const studentData = DB.getStudentData();
                for (const c in studentData) if (studentData[c].some(s => s.NISN == nisn)) return showToast('NISN sudah terdaftar di kelas lain.', 'error');
                if (!studentData[kelas]) studentData[kelas] = [];
                studentData[kelas].push({ NISN: nisn, Nama: nama, 'Jenis Kelamin (L/P)': gender, Kelas: kelas, status: 'Aktif' });
                DB.setStudentData(studentData);
                showToast(`Siswa ${nama} berhasil ditambahkan ke kelas ${kelas}.`, 'success');
                document.getElementById('add-student-form').reset();
            }
            function populateManageStudentDropdown() { /* ... helpers ... */
                const selectedClass = document.getElementById('manage-class-select').value, studentSelect = document.getElementById('manage-student-select');
                studentSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>'; if (!selectedClass) return;
                const students = DB.getStudentData()[selectedClass] || [];
                students.sort((a, b) => a.Nama.localeCompare(b.Nama)).forEach(s => {
                    const option = document.createElement('option'); option.value = s.NISN; option.textContent = `${s.Nama} (${s.status})`;
                    if (s.status === 'Nonaktif') option.classList.add('nonaktif-text');
                    studentSelect.appendChild(option);
                });
            }
            function toggleStudentStatus(newStatus) { /* ... helpers ... */
                const selectedClass = document.getElementById('manage-class-select').value, selectedNisn = document.getElementById('manage-student-select').value;
                if (!selectedClass || !selectedNisn) return showToast('Harap pilih kelas dan siswa terlebih dahulu.', 'error');
                const studentData = DB.getStudentData();
                const student = studentData[selectedClass].find(s => s.NISN == selectedNisn);
                if (student) { student.status = newStatus; DB.setStudentData(studentData); showToast(`Status siswa ${student.Nama} berhasil diubah.`, 'success'); populateManageStudentDropdown(); }
            }
            function showAttendanceList() { /* ... helpers ... */
                const teacher = document.getElementById('teacher-name').value, subject = document.getElementById('subject').value, selectedClass = document.getElementById('class-select').value, date = document.getElementById('attendance-date').value;
                if (!teacher || !subject || !selectedClass || !date) return showToast('Harap lengkapi form absensi.', 'error');
                const allStudents = DB.getStudentData()[selectedClass] || [], activeStudents = allStudents.filter(s => s.status === 'Aktif');
                if (activeStudents.length === 0) return showToast(`Tidak ada siswa aktif untuk Kelas ${selectedClass}.`, 'info');
                const tableBody = document.getElementById('attendance-table-body'); tableBody.innerHTML = '';
                const existingRecord = DB.getAttendanceData()[`${date}_${selectedClass}_${subject}`];
                activeStudents.sort((a, b) => a.Nama.localeCompare(b.Nama)).forEach((student, index) => {
                    const tr = document.createElement('tr');
                    const isPresent = existingRecord ? existingRecord.records[student.NISN] === 'H' : true;
                    const keterangan = existingRecord ? existingRecord.records[student.NISN] : 'H';
                    tr.innerHTML = `<td>${index + 1}</td> <td>${student.NISN}</td> <td>${student.Nama}</td><td><input type="checkbox" class="status-checkbox" data-nisn="${student.NISN}" ${isPresent ? 'checked' : ''}></td><td><select class="keterangan-select" style="display: ${isPresent ? 'none' : 'block'};"><option value="S" ${keterangan === 'S' ? 'selected' : ''}>Sakit</option><option value="I" ${keterangan === 'I' ? 'selected' : ''}>Izin</option><option value="A" ${keterangan === 'A' ? 'selected' : ''}>Alfa</option></select></td>`;
                    tableBody.appendChild(tr);
                });
                document.getElementById('attendance-header').textContent = `Absensi Kelas ${selectedClass} - ${subject} - ${new Date(date).toLocaleDateString("id-ID", { weekday: "long", year: "numeric", month: "long", day: "numeric" })}`;
                document.getElementById('attendance-taking-section').style.display = 'block';
            }
            function renderRecapTable() { /* ... helpers ... */
                const selectedClass = document.getElementById('recap-class-filter').value;
                const tableHead = document.querySelector('#recap-table thead'), tableBody = document.querySelector('#recap-table tbody');
                tableHead.innerHTML = '<tr><th>No</th><th>NISN</th><th>Nama</th></tr>'; tableBody.innerHTML = '';
                if (!selectedClass) { tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 2rem; color: var(--text-color-light);">Silakan pilih kelas untuk melihat rekapitulasi.</td></tr>`; return; }
                const studentDataByClass = (DB.getStudentData()[selectedClass] || []).sort((a, b) => a.Nama.localeCompare(b.Nama));
                if (studentDataByClass.length === 0) return tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 2rem; color: var(--text-color-light);">Belum ada data siswa untuk kelas ${selectedClass}.</td></tr>`;
                const attendanceData = DB.getAttendanceData();
                const relevantKeys = Object.keys(attendanceData).filter(key => key.includes(`_${selectedClass}_`));
                const cols = relevantKeys.map(key => { const [date, , subject] = key.split('_'); return { date, subject, fullKey: key }; }).sort((a, b) => new Date(a.date) - new Date(b.date));
                let headerRow = '<tr><th>No</th><th>NISN</th><th>Nama</th>';
                cols.forEach(({ date, subject }) => { const formattedDate = new Date(date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }); headerRow += `<th>${formattedDate}<br><small style="font-weight:400; text-transform:none;">${subject}</small></th>`; });
                tableHead.innerHTML = headerRow + '</tr>';
                studentDataByClass.forEach((student, index) => {
                    let bodyRow = `<tr><td>${index + 1}</td><td>${student.NISN}</td><td>${student.Nama} ${student.status === 'Nonaktif' ? '<span class="nonaktif-text">(Nonaktif)</span>' : ''}</td>`;
                    cols.forEach(({ date, subject, fullKey }) => {
                        const status = attendanceData[fullKey]?.records[student.NISN] || '-';
                        const teacher = attendanceData[fullKey]?.teacher || '';
                        bodyRow += `<td class="rekap-edit-cell" data-date="${date}" data-class="${selectedClass}" data-subject="${subject}" data-teacher="${teacher}">${status}</td>`;
                    });
                    tableBody.innerHTML += bodyRow + '</tr>';
                });
                if (cols.length === 0) tableBody.innerHTML += `<tr><td colspan="3" style="text-align:center; padding: 2rem; color: var(--text-color-light);">Belum ada riwayat absensi untuk kelas ${selectedClass}.</td></tr>`;
            }

            setupAppCore();
        }

        // =========================================================================
        // PROTA & PROSEM APP LOGIC
        // =========================================================================
        function initializeProtaProsemApp() {
            let appData = {};
            const pageContainer = document.getElementById('protaProsemPage');

            function formatTanggal(dateString) {
                const options = { day: '2-digit', month: 'long', year: 'numeric' };
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) throw new Error("Invalid date");
                    return date.toLocaleDateString('id-ID', options);
                } catch (e) { return new Date().toLocaleDateString('id-ID', options); }
            }
            
            function showStep(stepId) {
                pageContainer.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
                pageContainer.querySelector(`#${stepId}`).classList.add('active');
                
                let stepNumber = 1;
                if (stepId.includes('konfirmasi')) stepNumber = 2;
                else if (stepId.includes('final')) stepNumber = 3;
                else if (stepId.includes('hasil')) stepNumber = 4;
                     
                pageContainer.querySelectorAll('.stepper .step').forEach(step => {
                    const currentStepNumber = parseInt(step.dataset.step);
                    step.classList.remove('active', 'completed');
                    if (currentStepNumber < stepNumber) step.classList.add('completed');
                    else if (currentStepNumber === stepNumber) step.classList.add('active');
                });

                const progressPercentage = ((stepNumber - 1) / 3) * 100;
                pageContainer.querySelector('#progress-line').style.width = `${progressPercentage}%`;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            function animateValue(obj, start, end, duration) {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.textContent = Math.floor(progress * (end - start) + start);
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            }
            
            function renderAlokasiTable(semesterType) { 
                const dataGanjil = { main: [ { month: 'Juli', total: 4, nonEffective: 2 }, { month: 'Agustus', total: 5, nonEffective: 1 }, { month: 'September', total: 4, nonEffective: 1 }, { month: 'Oktober', total: 4, nonEffective: 0 }, { month: 'November', total: 4, nonEffective: 0 }, { month: 'Desember', total: 4, nonEffective: 2 } ], uraian: [ { desc: 'Libur Akhir Semester & Matsama', weeks: 2 }, { desc: 'Kegiatan HUT RI', weeks: 1 }, { desc: 'Sumatif Tengah Semester (STS)', weeks: 1 }, { desc: 'Sumatif Akhir Semester (SAS)', weeks: 1 }, { desc: 'Class Meeting & Libur', weeks: 1 } ] };
                const dataGenap = { main: [ { month: 'Januari', total: 4, nonEffective: 1 }, { month: 'Februari', total: 4, nonEffective: 1 }, { month: 'Maret', total: 4, nonEffective: 2 }, { month: 'April', total: 4, nonEffective: 2 }, { month: 'Mei', total: 5, nonEffective: 0 }, { month: 'Juni', total: 4, nonEffective: 2 } ], uraian: [ { desc: 'Libur Semester', weeks: 1 }, { desc: 'Ujian Praktek', weeks: 1 }, { desc: 'STS & Libur Awal Ramadhan', weeks: 2 }, { desc: 'Libur Idul Fitri', weeks: 2 }, { desc: 'SAS & Libur', weeks: 2 } ] };
                const data = semesterType === 'ganjil' ? dataGanjil : dataGenap; 
                const weekTableBody = pageContainer.querySelector('#week-table-body');
                const uraianTableBody = pageContainer.querySelector('#uraian-table-body');
                weekTableBody.innerHTML = ''; uraianTableBody.innerHTML = ''; 
                data.main.forEach((item, i) => weekTableBody.innerHTML += `<tr><td>${i+1}</td><td class="align-left">${item.month}</td><td><input type="number" class="week-total" value="${item.total}" min="0"></td><td><input type="number" class="week-non-effective" value="${item.nonEffective}" min="0"></td><td class="week-effective">0</td></tr>`); 
                data.uraian.forEach((item, i) => uraianTableBody.innerHTML += `<tr><td>${i+1}</td><td class="align-left"><input type="text" value="${item.desc}"></td><td><input type="number" class="uraian-input" value="${item.weeks}" min="0"></td></tr>`); 
                for (let i = 0; i < 3; i++) { uraianTableBody.innerHTML += `<tr><td>${data.uraian.length+i+1}</td><td class="align-left"><input type="text" placeholder="Kegiatan lainnya..."></td><td><input type="number" class="uraian-input" value="0" min="0"></td></tr>`; } 
                calculateTotals(); 
            }

            function calculateTotals() { 
                let totalMinggu = 0, totalTidakEfektif = 0, totalEfektif = 0;
                pageContainer.querySelector('#week-table-body').querySelectorAll('tr').forEach(row => {
                    const totalVal = parseInt(row.querySelector('.week-total').value) || 0;
                    const nonEffectiveVal = parseInt(row.querySelector('.week-non-effective').value) || 0;
                    const effectiveVal = Math.max(0, totalVal - nonEffectiveVal);
                    row.querySelector('.week-effective').textContent = effectiveVal;
                    totalMinggu += totalVal; totalTidakEfektif += nonEffectiveVal; totalEfektif += effectiveVal;
                });
                let totalUraian = 0;
                pageContainer.querySelector('#uraian-table-body').querySelectorAll('.uraian-input').forEach(input => { totalUraian += parseInt(input.value) || 0; });
                
                appData.totalMinggu = totalMinggu; appData.totalMingguTidakEfektif = totalTidakEfektif; appData.totalMingguEfektif = totalEfektif;
                
                const duration = 500;
                animateValue(pageContainer.querySelector('#total-minggu'), 0, totalMinggu, duration);
                animateValue(pageContainer.querySelector('#total-tidak-efektif'), 0, totalTidakEfektif, duration);
                animateValue(pageContainer.querySelector('#total-efektif'), 0, totalEfektif, duration);
                animateValue(pageContainer.querySelector('#total-uraian-minggu'), 0, totalUraian, duration);
                
                pageContainer.querySelector('#summary-total-minggu').textContent = totalMinggu; 
                pageContainer.querySelector('#summary-tidak-efektif').textContent = totalTidakEfektif; 
                pageContainer.querySelector('#summary-efektif').textContent = totalEfektif;
                pageContainer.querySelector('#summary-efektif-2').textContent = totalEfektif; 
                const jpPerMinggu = parseInt(pageContainer.querySelector('#jpPerMinggu').value) || 0; 
                const totalJP = totalEfektif * jpPerMinggu;
                animateValue(pageContainer.querySelector('#summary-total-jp'), 0, totalJP, duration);
                
                const validationMessage = pageContainer.querySelector('#validation-message'); 
                if (totalTidakEfektif === totalUraian && totalTidakEfektif > 0) { 
                    validationMessage.innerHTML = '<i class="fa-solid fa-check-circle"></i> Valid'; 
                    validationMessage.className = 'validation-message validation-ok'; 
                } else { 
                    validationMessage.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Tidak Valid (T.E. Tabel 1 [${totalTidakEfektif}] vs Tabel 2 [${totalUraian}])`; 
                    validationMessage.className = 'validation-message validation-error'; 
                } 
            }

            function initStep1() {
                pageContainer.querySelector('#info-tanggal').valueAsDate = new Date();
                pageContainer.querySelector('#semester-selector').addEventListener('change', (e) => renderAlokasiTable(e.target.value));
                pageContainer.querySelector('#alokasi-waktu-section').addEventListener('input', calculateTotals);
                pageContainer.querySelector('#lanjut-ke-konfirmasi').addEventListener('click', () => {
                     appData.jpPerMinggu = parseInt(pageContainer.querySelector('#jpPerMinggu').value) || 2;
                     appData.totalJpEfektif = appData.totalMingguEfektif * appData.jpPerMinggu;
                     initStep2();
                     showStep('prosem-konfirmasi-section');
                });
                renderAlokasiTable('ganjil');
            }
            
            function initStep2() {
                const konfirmasiBody = pageContainer.querySelector('#konfirmasi-tbody');
                const nonEffectiveWeeksMap = {};
                pageContainer.querySelectorAll('#week-table-body tr').forEach(row => {
                    const monthName = row.cells[1].textContent;
                    const nonEffectiveCount = parseInt(row.querySelector('.week-non-effective').value) || 0;
                    nonEffectiveWeeksMap[monthName] = nonEffectiveCount;
                });
                const semester = pageContainer.querySelector('#semester-selector').value;
                const bulanAktif = semester === 'ganjil' ? ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'] : ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
                
                konfirmasiBody.innerHTML = '';
                bulanAktif.forEach(bulan => {
                    const nonEffectiveCount = nonEffectiveWeeksMap[bulan] || 0;
                    let checkboxHtml = '';
                    for (let i = 1; i <= 5; i++) { 
                        checkboxHtml += `<div class="custom-checkbox"><input type="checkbox" id="chk-${bulan}-${i}" value="${i}" ${i <= nonEffectiveCount ? 'checked' : ''}><label for="chk-${bulan}-${i}">M-${i}</label></div>`; 
                    }
                    konfirmasiBody.innerHTML += `<tr><td class="align-left" style="font-weight:600;">${bulan}</td><td><div class="checkbox-container" data-month="${bulan}">${checkboxHtml}</div></td></tr>`;
                });

                pageContainer.querySelector('#kembali-ke-langkah-1').addEventListener('click', () => showStep('alokasi-waktu-section'));
                pageContainer.querySelector('#lanjut-ke-langkah-3').addEventListener('click', () => {
                    initStep3();
                    showStep('prosem-final-section');
                });
            }

            function initStep3() {
                pageContainer.querySelector('#jp-tersedia-container b').textContent = `${appData.totalJpEfektif} JP`;
                const penyusunanBody = pageContainer.querySelector('#penyusunan-tbody');
                if (penyusunanBody.rows.length === 0) {
                    tambahBarisPenyusunan("Bab 1: Keluarga dan Kehidupan Awal", "Mengenal Lokasi & Keberadaan Diri", 12); 
                    tambahBarisPenyusunan("Bab 2: Sosialisasi di Masyarakat", "Interaksi, Sosialisasi, Institusi Sosial", 12);
                    tambahBarisPenyusunan("Bab 3: Pemenuhan Kebutuhan Manusia", "Aktivitas Manusia dalam Memenuhi Kebutuhan", 12);
                    tambahBarisPenyusunan("Asesmen Sumatif", "Materi Semester Ganjil", 2); 
                }
                validasiTotalJP();
                pageContainer.querySelector('#kembali-ke-langkah-2').addEventListener('click', () => showStep('prosem-konfirmasi-section'));
                pageContainer.querySelector('#generate-button').addEventListener('click', () => {
                    initStep4();
                    showStep('hasil-section');
                });
            }
            
            function tambahBarisPenyusunan(materi = '', lingkup = '', jp = '') { 
                const tableBody = pageContainer.querySelector('#penyusunan-tbody'); 
                const newRow = tableBody.insertRow(); 
                newRow.style.animation = "fadeIn 0.5s";
                newRow.innerHTML = `<td></td><td class="align-left"><input type="text" placeholder="Isi materi atau tujuan pembelajaran" value="${materi}"></td><td class="align-left"><input type="text" placeholder="Isi lingkup materi" value="${lingkup}"></td><td><input type="number" class="jp-input" value="${jp}" min="0"></td><td><button class="action-button btn-danger"><i class="fa-solid fa-trash-can"></i></button></td>`; 
                newRow.querySelector('.btn-danger').addEventListener('click', (e) => hapusBarisPenyusunan(e.currentTarget));
                newRow.querySelector('.jp-input').addEventListener('input', validasiTotalJP);
                perbaruiNomorUrut(); 
                validasiTotalJP(); 
            }
            function hapusBarisPenyusunan(button) { 
                const row = button.closest('tr');
                row.style.transition = "opacity 0.3s";
                row.style.opacity = 0;
                setTimeout(() => {
                    row.remove(); 
                    perbaruiNomorUrut(); 
                    validasiTotalJP(); 
                }, 300);
            }
            function perbaruiNomorUrut() { pageContainer.querySelectorAll('#penyusunan-tbody tr').forEach((row, index) => { row.cells[0].textContent = index + 1; }); }
            function validasiTotalJP() { 
                let totalJPAlokasi = 0; 
                pageContainer.querySelectorAll('.jp-input').forEach(input => { totalJPAlokasi += parseInt(input.value) || 0; }); 
                pageContainer.querySelector('#total-jp-dialokasikan').textContent = totalJPAlokasi; 
                const container = pageContainer.querySelector('#validation-status-container'); 
                const generateBtn = pageContainer.querySelector('#generate-button'); 
                if (totalJPAlokasi === appData.totalJpEfektif && totalJPAlokasi > 0) { 
                    container.innerHTML = `<p class="validation-message validation-ok"><i class="fa-solid fa-check-circle"></i> Cocok! Total JP yang dialokasikan (${totalJPAlokasi} JP) sesuai.</p>`; 
                    generateBtn.disabled = false; 
                } else { 
                    container.innerHTML = `<p class="validation-message validation-error"><i class="fa-solid fa-triangle-exclamation"></i> Alokasi JP (${totalJPAlokasi}) tidak sama dengan JP Efektif (${appData.totalJpEfektif}).</p>`; 
                    generateBtn.disabled = true; 
                } 
            }

            function initStep4() {
                pageContainer.querySelector('#kembali-ke-langkah-3-hasil').addEventListener('click', () => showStep('prosem-final-section'));
            }

            function getIdentityData() {
                return { 
                    sekolah: pageContainer.querySelector('#info-sekolah').value, guru: pageContainer.querySelector('#input-nama-guru').value, nip_guru: pageContainer.querySelector('#input-nip-guru').value, 
                    kepsek: pageContainer.querySelector('#input-nama-kepsek').value, nip_kepsek: pageContainer.querySelector('#input-nip-kepsek').value, mapel: pageContainer.querySelector('#info-mapel').value, 
                    kelas: pageContainer.querySelector('#info-kelas').value, semester: pageContainer.querySelector('#semester-selector').options[pageContainer.querySelector('#semester-selector').selectedIndex].text, 
                    tapel: pageContainer.querySelector('#info-tapel').value, lokasi: pageContainer.querySelector('#info-lokasi').value, tanggal: pageContainer.querySelector('#info-tanggal').value
                };
            }

            function gatherFinalData() {
                appData.identitas = getIdentityData();
                appData.konfirmasiMingguTidakAktif = {};
                pageContainer.querySelectorAll('.konfirmasi-table .checkbox-container').forEach(container => { 
                    const month = container.dataset.month; 
                    appData.konfirmasiMingguTidakAktif[month] = Array.from(container.querySelectorAll('input:checked')).map(cb => parseInt(cb.value)); 
                });
                appData.materiList = Array.from(pageContainer.querySelectorAll('#penyusunan-tbody tr')).map((row, i) => ({ 
                    no: i + 1, materi: row.cells[1].querySelector('input').value, lingkup: row.cells[2].querySelector('input').value, jp: parseInt(row.cells[3].querySelector('input').value) || 0 
                }));
            }

            function printDocument(htmlContent, pageClass = '') {
                const printArea = pageContainer.querySelector('#print-area');
                printArea.innerHTML = htmlContent;
                const outputDoc = printArea.querySelector('.output-document');
                if (outputDoc && pageClass) outputDoc.classList.add(pageClass);
                window.print();
                printArea.innerHTML = '';
            }

            function generateAlokasiWaktu() {
                const identitas = getIdentityData();
                const formattedDate = formatTanggal(identitas.tanggal);
                const signatureHtml = `<div class="signature-container"><div class="signature-block"><p>Mengetahui,</p><p>Kepala Madrasah</p><div class="signature-space"></div><p class="signature-name">${identitas.kepsek || '..............................'}</p><p>NIP. ${identitas.nip_kepsek || '-'}</p></div><div class="signature-block"><p>${identitas.lokasi || '........'}, ${formattedDate}</p><p>Guru Mata Pelajaran</p><div class="signature-space"></div><p class="signature-name">${identitas.guru || '..............................'}</p><p>NIP. ${identitas.nip_guru || '-'}</p></div></div>`;
                const alokasiTablesClone = pageContainer.querySelector('#alokasi-waktu-section .table-grid-wrapper').cloneNode(true);
                const summaryClone = pageContainer.querySelector('#alokasi-waktu-section .calculation-summary').cloneNode(true);
                alokasiTablesClone.querySelectorAll('input').forEach(input => { const text = document.createTextNode(input.value); input.parentNode.replaceChild(text, input); });
                summaryClone.querySelectorAll('input').forEach(input => { const text = document.createTextNode(input.value); input.parentNode.replaceChild(text, input); });
                
                let alokasiHtml = `
                    <div id="alokasi-waktu-content" class="output-document active">
                        <div class="output-header"><h1>ANALISIS ALOKASI WAKTU</h1><h2>Tahun Pelajaran ${identitas.tapel}</h2></div>
                        <table class="output-info-table">
                            <tr><td>Satuan Pendidikan</td><td>: ${identitas.sekolah}</td></tr>
                            <tr><td>Mata Pelajaran</td><td>: ${identitas.mapel}</td></tr>
                            <tr><td>Kelas / Semester</td><td>: ${identitas.kelas} / ${identitas.semester}</td></tr>
                        </table>
                        <h3 style="margin-top: 20px;">A. Perhitungan Alokasi Waktu</h3>
                        ${alokasiTablesClone.outerHTML}
                        <h3 style="margin-top: 20px;">B. Rangkuman dan Validasi</h3>
                        ${summaryClone.outerHTML}
                        ${signatureHtml}
                    </div>`;
                printDocument(alokasiHtml);
            }

            function generateProsem() {
                gatherFinalData();
                const { identitas, materiList } = appData;
                const formattedDate = formatTanggal(identitas.tanggal);
                const signatureHtml = `<div class="signature-container"><div class="signature-block"><p>Mengetahui,</p><p>Kepala Madrasah</p><div class="signature-space"></div><p class="signature-name">${identitas.kepsek || '..............................'}</p><p>NIP. ${identitas.nip_kepsek || '-'}</p></div><div class="signature-block"><p>${identitas.lokasi || '........'}, ${formattedDate}</p><p>Guru Mata Pelajaran</p><div class="signature-space"></div><p class="signature-name">${identitas.guru || '..............................'}</p><p>NIP. ${identitas.nip_guru || '-'}</p></div></div>`;
                const bulanAktif = Object.keys(appData.konfirmasiMingguTidakAktif);
                let allocationMap = [];
                bulanAktif.forEach(bulan => { for (let i = 1; i <= 5; i++) { const isEffective = !appData.konfirmasiMingguTidakAktif[bulan].includes(i); allocationMap.push({ month: bulan, week: i, isEffective: isEffective, allocatedTo: null }); } });
                let mapPointer = 0;
                appData.materiList.forEach(item => { let checksNeeded = Math.ceil(item.jp / appData.jpPerMinggu); for (let i = 0; i < checksNeeded; i++) { while(mapPointer < allocationMap.length && (!allocationMap[mapPointer].isEffective || allocationMap[mapPointer].allocatedTo !== null)) { mapPointer++; } if (mapPointer < allocationMap.length) { allocationMap[mapPointer].allocatedTo = item.no; mapPointer++; } } });

                let prosemHtml = `<div id="prosem-content" class="output-document active"><div class="output-header"><h1>PROGRAM SEMESTER (PROSEM)</h1><h2>Tahun Pelajaran ${identitas.tapel}</h2></div><table class="output-info-table"><tr><td>Satuan Pendidikan</td><td>: ${identitas.sekolah}</td><td>Kelas / Semester</td><td>: ${identitas.kelas} / ${identitas.semester}</td></tr><tr><td>Mata Pelajaran</td><td>: ${identitas.mapel}</td><td>Alokasi Waktu</td><td>: ${appData.jpPerMinggu} JP / Minggu</td></tr></table><div class="prosem-table-wrapper"><table class="custom-table prosem-table"><thead><tr><th rowspan="2">No.</th><th rowspan="2" class="align-left">Materi / TP</th><th rowspan="2" class="align-left">Lingkup</th><th rowspan="2">JP</th>${bulanAktif.map(bln => `<th colspan="5">${bln}</th>`).join('')}</tr><tr>${bulanAktif.map(() => '<th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>').join('')}</tr></thead><tbody>`;
                materiList.forEach(item => { prosemHtml += `<tr><td>${item.no}</td><td class="align-left">${item.materi}</td><td class="align-left">${item.lingkup}</td><td>${item.jp}</td>`; allocationMap.forEach(week => { prosemHtml += `<td class="${week.allocatedTo === item.no ? 'filled-week' : ''}">${week.allocatedTo === item.no ? '‚úì' : ''}</td>`; }); prosemHtml += `</tr>`; });
                prosemHtml += `<tr style="font-style: italic; background-color: #f8f9fa;"><td colspan="3" class="align-left">Kegiatan Tengah & Akhir Semester, Libur, dll.</td><td>${appData.totalMingguTidakEfektif}</td><td colspan="${(bulanAktif.length * 5)}" style="text-align:center;">${appData.totalMingguTidakEfektif} Minggu Tidak Efektif</td></tr>`;
                prosemHtml += `</tbody></table></div>${signatureHtml}</div>`;
                printDocument(prosemHtml, 'prosem-output-page');
            }

            function generateProta() {
                gatherFinalData();
                const { identitas, materiList } = appData;
                const formattedDate = formatTanggal(identitas.tanggal);
                const signatureHtml = `<div class="signature-container"><div class="signature-block"><p>Mengetahui,</p><p>Kepala Madrasah</p><div class="signature-space"></div><p class="signature-name">${identitas.kepsek || '..............................'}</p><p>NIP. ${identitas.nip_kepsek || '-'}</p></div><div class="signature-block"><p>${identitas.lokasi || '........'}, ${formattedDate}</p><p>Guru Mata Pelajaran</p><div class="signature-space"></div><p class="signature-name">${identitas.guru || '..............................'}</p><p>NIP. ${identitas.nip_guru || '-'}</p></div></div>`;
                let protaHtml = `<div id="prota-content" class="output-document active"><div class="output-header"><h1>PROGRAM TAHUNAN (PROTA)</h1><h2>Tahun Pelajaran ${identitas.tapel}</h2></div><table class="output-info-table"><tr><td>Satuan Pendidikan</td><td>: ${identitas.sekolah}</td></tr><tr><td>Mata Pelajaran</td><td>: ${identitas.mapel}</td></tr><tr><td>Kelas</td><td>: ${identitas.kelas}</td></tr></table><table class="custom-table prota-table"><thead><tr><th>No.</th><th class="align-left">Materi Pokok / TP</th><th class="align-left">Lingkup Materi</th><th>Alokasi Waktu (JP)</th><th>Semester</th></tr></thead><tbody>`;
                let totalJp = 0;
                materiList.forEach(item => { totalJp += item.jp; protaHtml += `<tr><td>${item.no}</td><td class="align-left">${item.materi}</td><td class="align-left">${item.lingkup}</td><td>${item.jp}</td><td>${identitas.semester.replace('Semester ', '')}</td></tr>`; });
                protaHtml += `</tbody><tfoot><tr><td colspan="3" class="align-left" style="text-align:right;"><b>JUMLAH</b></td><td><b>${totalJp}</b></td><td></td></tr></tfoot></table>${signatureHtml}</div>`;
                printDocument(protaHtml);
            }

            // --- INITIALIZATION & EVENT LISTENERS ---
            pageContainer.querySelector('#tambah-baris-penyusunan').addEventListener('click', () => tambahBarisPenyusunan());
            pageContainer.querySelector('#cetakAlokasiWaktu').addEventListener('click', generateAlokasiWaktu);
            pageContainer.querySelector('#cetakProsem').addEventListener('click', generateProsem);
            pageContainer.querySelector('#cetakProta').addEventListener('click', generateProta);
            initStep1();
        }

    </script>
</body>
</html>
